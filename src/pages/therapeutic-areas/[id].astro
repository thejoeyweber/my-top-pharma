---
/**
 * Therapeutic Area Detail Page
 * 
 * Displays detailed information for a specific therapeutic area,
 * including related companies, products, and websites.
 */
import { supabase } from '../../lib/supabase';
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import Breadcrumbs from '../../components/molecules/Breadcrumbs.astro';
import TabGroup from '../../components/molecules/TabGroup.astro';
import CompanyCard from '../../components/molecules/CompanyCard.astro';
import ProductCard from '../../components/molecules/ProductCard.astro';
import WebsiteCard from '../../components/molecules/WebsiteCard.astro';
import { dbCompanyToCompany } from '../../interfaces/entities/Company';
import { dbProductToProduct } from '../../interfaces/entities/Product';
import { dbWebsiteToWebsite } from '../../interfaces/entities/Website';
import { dbTherapeuticAreaToTherapeuticArea } from '../../interfaces/entities/TherapeuticArea';
import type { TherapeuticArea } from '../../interfaces/entities';

// Get the therapeutic area ID from the URL
const { id } = Astro.params;

// Function to generate static paths for all therapeutic areas
export async function getStaticPaths() {
  const { data: therapeuticAreas } = await supabase
    .from('therapeutic_areas')
    .select('id');
  
  if (!therapeuticAreas) {
    return [];
  }
  
  return therapeuticAreas.map(ta => ({
    params: { id: ta.id }
  }));
}

// Fetch the therapeutic area by ID
const { data: taData } = await supabase
  .from('therapeutic_areas')
  .select('*')
  .eq('id', id)
  .single();

// Redirect to the therapeutic areas list if the therapeutic area is not found
if (!taData) {
  return Astro.redirect('/therapeutic-areas');
}

const therapeuticArea: TherapeuticArea = dbTherapeuticAreaToTherapeuticArea(taData);

// Fetch companies related to this therapeutic area
const { data: companiesData } = await supabase
  .from('companies')
  .select('*')
  .contains('therapeutic_area_ids', [id]);

const companies = companiesData ? companiesData.map(dbCompanyToCompany) : [];

// Fetch products related to this therapeutic area
const { data: productsData } = await supabase
  .from('products')
  .select('*')
  .contains('therapeutic_area_ids', [id]);

const products = productsData ? productsData.map(dbProductToProduct) : [];

// Fetch websites related to this therapeutic area
const { data: websitesData } = await supabase
  .from('websites')
  .select('*')
  .contains('therapeutic_area_ids', [id]);

const websites = websitesData ? websitesData.map(dbWebsiteToWebsite) : [];

// Set up breadcrumbs
const breadcrumbs = [
  { text: 'Home', href: '/' },
  { text: 'Therapeutic Areas', href: '/therapeutic-areas' },
  { text: therapeuticArea.name, href: `/therapeutic-areas/${id}` }
];

// Set up tabs
const tabs = [
  { 
    id: 'overview', 
    label: 'Overview', 
    count: null,
    content: 'Overview content will go here...' 
  },
  { 
    id: 'companies', 
    label: 'Companies', 
    count: companies.length,
    content: companies.length > 0 ? (
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {companies.map(company => (
          <CompanyCard company={company} />
        ))}
      </div>
    ) : (
      <p class="text-gray-500">No companies found for this therapeutic area.</p>
    )
  },
  { 
    id: 'products', 
    label: 'Products', 
    count: products.length,
    content: products.length > 0 ? (
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {products.map(product => (
          <ProductCard product={product} />
        ))}
      </div>
    ) : (
      <p class="text-gray-500">No products found for this therapeutic area.</p>
    )
  },
  { 
    id: 'websites', 
    label: 'Websites', 
    count: websites.length,
    content: websites.length > 0 ? (
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {websites.map(website => (
          <WebsiteCard website={website} />
        ))}
      </div>
    ) : (
      <p class="text-gray-500">No websites found for this therapeutic area.</p>
    )
  }
];

// Get active tab from URL query parameter or default to 'overview'
const activeTab = Astro.url.searchParams.get('tab') || 'overview';
---

<DashboardLayout title={`${therapeuticArea.name} - Therapeutic Area | MyTopPharma`}>
  <div class="container mx-auto px-4 py-8">
    <Breadcrumbs items={breadcrumbs} />
    
    <div class="bg-white rounded-lg shadow-md p-6 mt-6">
      <div class="flex flex-col md:flex-row md:items-center justify-between mb-6">
        <div>
          <h1 class="text-2xl font-bold text-gray-900">{therapeuticArea.name}</h1>
          {therapeuticArea.description && (
            <p class="text-gray-600 mt-2">{therapeuticArea.description}</p>
          )}
        </div>
      </div>
      
      <TabGroup tabs={tabs} activeTab={activeTab} baseUrl={`/therapeutic-areas/${id}`} />
    </div>
  </div>
</DashboardLayout> 