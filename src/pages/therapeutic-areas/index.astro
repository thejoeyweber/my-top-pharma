---
/**
 * Therapeutic Areas Index Page
 * 
 * Displays a list of all therapeutic areas with statistics (number of companies, products, websites).
 */
import DashboardLayout from '../../components/templates/DashboardLayout.astro';
import Card from '../../components/atoms/Card.astro';
import Button from '../../components/atoms/Button.astro';
import SortSelect from '../../components/molecules/SortSelect.astro';
import TherapeuticAreaCard from '../../components/molecules/TherapeuticAreaCard.astro';
import DataSourceVisualizer from '../../components/DataSourceVisualizer.astro';

// Import therapeutic area utilities instead of direct Supabase access
import { getTherapeuticAreas, getTherapeuticAreaFilters } from '../../lib/utils/therapeuticAreaUtils';
import type { TherapeuticArea } from '../../interfaces/entities';

// Get URL query parameters for filtering and sorting
const url = new URL(Astro.request.url);
const params = url.searchParams;

// Extract filter and sort parameters
const sortParam = params.get('sort') || 'name_asc';
const search = params.get('search') || '';
const minCompanies = params.get('minCompanies') ? parseInt(params.get('minCompanies')) : 0;
const minProducts = params.get('minProducts') ? parseInt(params.get('minProducts')) : 0;

// Parse sort parameter 
const [sortField, sortDirection] = sortParam.split('_');

// Fetch therapeutic areas with statistics using the utility function
const { therapeuticAreas: areaStats, totalCount } = await getTherapeuticAreas({
  search,
  sortBy: sortField,
  sortDirection: sortDirection as 'asc' | 'desc', 
  minCompanies,
  minProducts
});

// Get sort options from the utility function
const { sortOptions } = await getTherapeuticAreaFilters();

// Helper function to build URLs with updated parameters
const updateUrlParams = (updates: Record<string, string | null>) => {
  const newUrl = new URL(Astro.request.url);
  
  Object.entries(updates).forEach(([key, value]) => {
    if (value === null) {
      newUrl.searchParams.delete(key);
    } else {
      newUrl.searchParams.set(key, value);
    }
  });
  
  return newUrl.pathname + newUrl.search;
};
---

<DashboardLayout title="Therapeutic Areas">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Added visual header that connects to detail page design -->
    <div class="mb-6 overflow-hidden">
      <div class="flex border border-gray-100 rounded-lg shadow-sm overflow-hidden">
        <div class="w-3 bg-gradient-to-b from-amber-500 to-amber-600"></div>
        <div class="p-6 flex items-center">
          <div class="bg-white p-3 rounded-full shadow-sm mr-4">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-amber-600" fill="currentColor" viewBox="0 0 612 612">
              <g>
                <path d="M380.406,254.483c-7.043,3.727-14.33,6.947-21.83,9.607c-16.626,5.899-34.283,9.08-52.575,9.08
                  c-33.516,0-66.005,7.368-96.563,21.901c-7.149,3.4-14.112,7.16-20.886,11.26c-4.681,2.834-9.263,5.844-13.756,9.005
                  c-4.306,3.03-8.526,6.205-12.652,9.531c-10.795,8.703-20.974,18.401-30.467,29.075c-45.35,50.992-70.326,118.535-70.326,190.186
                  v47.975c0,10.989,8.908,19.897,19.897,19.897h26.529c10.988,0,19.897-8.908,19.897-19.897v-31.137h14.923h14.923h296.963h14.923
                  h14.923v31.137c0,10.989,8.908,19.897,19.897,19.897h26.529c10.988,0,19.897-8.908,19.897-19.897v-47.975
                  c0-71.652-24.975-139.194-70.325-190.186c-9.493-10.674-19.672-20.372-30.467-29.075c-11.004,7.412-22.507,13.983-34.475,19.675
                  c-11.429,5.436-23.101,9.98-34.975,13.637c23.809,12.596,44.8,31.04,61.573,53.719h-18.929h-20.193H209.144H188.95h-18.929
                  c16.774-22.679,37.764-41.123,61.573-53.719c7.044-3.726,14.33-6.947,21.83-9.607c16.626-5.899,34.283-9.08,52.576-9.08
                  c33.516,0,66.005-7.368,96.563-21.901c7.149-3.4,14.112-7.16,20.886-11.26c4.681-2.834,9.263-5.844,13.756-9.005
                  c4.306-3.03,8.525-6.204,12.652-9.531c10.795-8.703,20.975-18.401,30.467-29.075c45.35-50.992,70.325-118.535,70.325-190.186
                  V19.897C550.649,8.908,541.741,0,530.752,0h-26.529c-10.988,0-19.897,8.908-19.897,19.897v31.071h-14.923h-14.923H157.519h-14.923
                  h-14.923V19.897C127.674,8.908,118.765,0,107.777,0H81.248C70.259,0,61.351,8.908,61.351,19.897v48.638
                  c0,71.652,24.975,139.194,70.325,190.186c9.493,10.674,19.672,20.372,30.467,29.075c11.004-7.412,22.507-13.983,34.475-19.676
                  c11.429-5.435,23.101-9.98,34.975-13.637c-24.064-12.731-45.249-31.435-62.111-54.448h18.853h20.09h195.146h20.09h18.854
                  C425.655,223.048,404.471,241.752,380.406,254.483z M170.966,471.59h270.069h15.944h15.763c3.174,9.575,5.739,19.49,7.64,29.687
                  H465.2h-15.245H162.046h-15.245H131.62c1.901-10.196,4.466-20.111,7.64-29.687h15.763H170.966z M441.312,140.344H170.688h-15.922
                  h-15.748c-3.138-9.578-5.671-19.493-7.536-29.687h15.181h15.23h288.216h15.23h15.182c-1.866,10.194-4.399,20.108-7.536,29.687
                  h-15.748H441.312z"/>
              </g>
            </svg>
          </div>
          <div>
            <h1 class="text-2xl font-bold text-gray-900">Therapeutic Areas</h1>
            <p class="text-gray-600 text-sm">Find medical and therapeutic domains across the pharmaceutical industry</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Filter Bar -->
    <div class="mb-6">
      <Card>
        <div class="p-4">
          <form id="filter-form" method="get" action="/therapeutic-areas">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-4">
              <!-- Search input -->
              <div class="w-full md:w-1/3">
                <input 
                  type="text" 
                  id="search" 
                  name="search" 
                  value={search}
                  placeholder="Search therapeutic areas..."
                  class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                />
              </div>
              
              <!-- Sort Options -->
              <div class="flex items-center space-x-3">
                <SortSelect 
                  options={sortOptions}
                  selected={sortParam}
                  onChange={(value) => updateUrlParams({ sort: value })}
                />
              </div>
            </div>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <!-- Company Count Filter -->
              <div>
                <label for="minCompanies" class="block text-sm font-medium text-gray-700">
                  Minimum Companies
                </label>
                <div class="mt-1 flex rounded-md shadow-sm">
                  <input
                    type="number"
                    name="minCompanies"
                    id="minCompanies"
                    min="0"
                    value={minCompanies > 0 ? minCompanies : ""}
                    placeholder="0"
                    class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                  />
                </div>
              </div>
              
              <!-- Product Count Filter -->
              <div>
                <label for="minProducts" class="block text-sm font-medium text-gray-700">
                  Minimum Products
                </label>
                <div class="mt-1 flex rounded-md shadow-sm">
                  <input
                    type="number"
                    name="minProducts"
                    id="minProducts"
                    min="0"
                    value={minProducts > 0 ? minProducts : ""}
                    placeholder="0"
                    class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                  />
                </div>
              </div>
            </div>
            
            <div class="mt-4 flex justify-end">
              <Button type="submit" variant="primary" size="md" name="Action" value="filter">
                Apply Filters
              </Button>
              <Button type="submit" variant="secondary" size="md" name="Action" value="reset" class="ml-3">
                Reset
              </Button>
            </div>
          </form>
        </div>
      </Card>
    </div>
    
    <!-- Results Count -->
    <div class="mb-4">
      <p class="text-sm text-gray-600">
        Showing <span class="font-semibold">{areaStats.length}</span> of <span class="font-semibold">{totalCount}</span> therapeutic areas
      </p>
    </div>
    
    <!-- Therapeutic Areas Grid -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
      {areaStats.map(stats => (
        <TherapeuticAreaCard 
          area={stats.area || stats}  
          companyCount={stats.companyCount} 
          productCount={stats.productCount}
          websiteCount={stats.websiteCount}
        />
      ))}
    </div>
    
    {areaStats.length === 0 && (
      <div class="bg-white p-10 rounded-lg shadow-sm border border-gray-100 text-center">
        <h3 class="text-lg font-medium text-gray-900 mb-2">No therapeutic areas found</h3>
        <p class="text-gray-600">Try adjusting your search or filter criteria.</p>
      </div>
    )}
    
    <!-- Data Source Indicator -->
    <div class="mt-8">
      <DataSourceVisualizer />
    </div>
  </div>
</DashboardLayout>

<script>
  // No client-side JavaScript needed for basic functionality
  // Form submits naturally via GET method
</script> 