---
/**
 * CompanyList.astro
 * 
 * Displays a list of pharmaceutical companies from the database
 */

// Import necessary dependencies
import { client } from "../../db/client";

// Interface for company data structure
interface Company {
  company_id: number;
  name: string;
  ticker_symbol?: string;
  headquarters?: string;
  description?: string;
}

// Define a function to fetch companies from the database
const fetchCompanies = async () => {
  try {
    // First try to use our database client to query the companies table
    const companies = await client.query(
      "SELECT company_id, name, ticker_symbol, headquarters, description FROM companies ORDER BY name LIMIT 10"
    );
    
    return companies;
  } catch (error) {
    console.error("Error fetching companies:", error);
    
    // Fallback to using the docker_db_query.py script via child_process
    try {
      const { execSync } = await import('child_process');
      const command = `python scripts/docker_db_query.py "SELECT company_id, name, ticker_symbol, headquarters, description FROM companies ORDER BY name LIMIT 10"`;
      
      const output = execSync(command, { cwd: process.cwd() }).toString();
      const result = JSON.parse(output);
      
      return Array.isArray(result) ? result : [];
    } catch (fallbackError) {
      console.error("Fallback error:", fallbackError);
      return [] as Company[];
    }
  }
};

// Fetch companies data
let companies: Company[] = [];
try {
  companies = await fetchCompanies();
} catch (error) {
  console.error("Failed to fetch companies:", error);
}

// Props
export interface Props {
  title?: string;
  class?: string;
}

const { title = "Pharmaceutical Companies", class: className = "" } = Astro.props;
---

<div class={`w-full mx-auto p-4 ${className}`} style="max-width: var(--max-w-3xl);">
  <h2 class="text-xl font-bold mb-4">{title}</h2>
  
  {companies.length > 0 ? (
    <ul class="space-y-4">
      {companies.map((company) => (
        <li class="border rounded-lg p-4 hover:bg-gray-50">
          <div class="flex justify-between items-start">
            <div>
              <h3 class="text-lg font-semibold">
                {company.name}
                {company.ticker_symbol && (
                  <span class="ml-2 text-sm bg-blue-100 text-blue-800 py-1 px-2 rounded">
                    {company.ticker_symbol}
                  </span>
                )}
              </h3>
              {company.headquarters && (
                <p class="text-sm text-gray-600">
                  <span class="font-medium">HQ:</span> {company.headquarters}
                </p>
              )}
              {company.description && (
                <p class="mt-2 text-gray-700">{company.description}</p>
              )}
            </div>
          </div>
        </li>
      ))}
    </ul>
  ) : (
    <div class="p-8 text-center">
      <p class="text-gray-500">No companies found</p>
      <p class="text-sm mt-2">
        Run the SEC EDGAR flow to populate the database with companies.
      </p>
    </div>
  )}
</div> 