# Supabase Integration for Top Pharma

This directory contains all Supabase-related configurations, migrations, and utilities for the Top Pharma application.

## Directory Structure

- `migrations/`: Contains SQL migration files with timestamp prefixes
- `config.toml`: Configuration for Supabase projects (generated by Supabase CLI)

## Database Migration Workflow

### Creating a New Migration

When you need to make changes to the database schema:

1. Create a new migration file with a timestamp prefix in the `migrations/` directory:

```bash
# Example naming convention
touch supabase/migrations/$(date +%Y%m%d)_descriptive_name.sql
```

2. Add your SQL statements to the migration file, following these guidelines:
   - Use `CREATE TABLE IF NOT EXISTS` to avoid errors if the table already exists
   - Add comments explaining the purpose of each table/column
   - Include appropriate indexes for fields that will be queried frequently
   - Add constraints to maintain data integrity

3. Test your migration locally:

```bash
npx supabase db push
```

### Applying Migrations to Production

All migrations in the `migrations/` directory will be applied in order by filename when you run:

```bash
npx supabase db push
```

This should be done:
- During initial setup
- After adding new migration files
- When deploying to a new environment

### Best Practices

1. **Make migrations idempotent**: Use `IF NOT EXISTS` / `IF EXISTS` clauses to ensure migrations can be run multiple times safely
2. **One change per migration**: Keep each migration focused on a single logical change
3. **Never modify existing migrations**: Once a migration has been applied to any environment, create a new migration for further changes
4. **Use transactions**: Wrap complex migrations in transactions to ensure atomicity
5. **Include rollback logic**: Where possible, include comments on how to reverse the migration

## Type Generation

To generate TypeScript types based on your database schema:

```bash
npx supabase gen types typescript --project-id <project-id> > src/types/supabase.ts
```

This should be run after significant schema changes to keep your TypeScript types in sync with the database.

## Connection Testing

You can test your Supabase connection by visiting [http://localhost:4321/supabase-test](http://localhost:4321/supabase-test) while the development server is running.

## Troubleshooting

### Common Issues

#### Migration Not Applied

If you're seeing "relation does not exist" errors:

1. Check if your migration file syntax is correct
2. Verify you've run `npm run db:push` successfully
3. Check Supabase dashboard to verify the migration was applied
4. Try reconnecting to Supabase by running:
   ```bash
   npx supabase link --project-ref <your-project-id>
   ```

#### Cannot Generate Types

If type generation fails:

1. Make sure you're linked to your Supabase project
2. Verify your Supabase project is online
3. Check that you have permission to access the schema
4. Try running the command manually:
   ```bash
   npx supabase gen types typescript --output src/types/supabase.ts
   ```

#### Supabase CLI Not Found

If you see "command not found" errors:

1. Run `npm install -g supabase` to install the CLI globally
2. Make sure your PATH includes npm global packages
3. Use `npx supabase` to run commands without global installation

#### Authentication Issues

If you're having trouble authenticating:

1. Make sure you're logged in with `supabase login`
2. Check that your `SUPABASE_ACCESS_TOKEN` environment variable is set
3. Verify your token has not expired in the Supabase dashboard
4. Re-link your project with `npx supabase link --project-ref <your-project-id>` 