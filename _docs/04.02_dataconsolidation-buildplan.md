# Data Consolidation Build Plan

## Overview

This document outlines the plan for consolidating data sources in the MyTopPharma application, transitioning from multiple sources (static JSON, Astro Content Collections) to a single source of truth using Supabase.

## Current Status

- ✅ Supabase integration is working for local development
- ✅ TypeScript types have been generated from the Supabase schema
- ✅ Entity interfaces have been updated to match the database schema
- ✅ Supabase utility library created at `app/src/lib/supabase.ts`
- ✅ Transitioned key Astro components to use Supabase directly:
  - ✅ ProductCard.astro
  - ✅ CompanyCard.astro
  - ✅ WebsiteCard.astro
  - ✅ TherapeuticAreaCard.astro
  - ✅ therapeutic-areas/[id].astro
- ⏳ In progress: Converting remaining components and pages to use Supabase directly

## Remaining Tasks

1. **Complete Component Transition**
   - Update remaining Astro components to use Supabase directly
   - Remove dependencies on utility files that use content collections

2. **Utility Functions Cleanup**
   - Deprecate and remove content collection utility functions
   - Remove or update any other utilities that depend on static JSON files

3. **Content Directory Removal**
   - Once all dependencies are resolved, delete the content directory

4. **Documentation Update**
   - Update README.md with new data access patterns
   - Add examples of using Supabase in Astro components

## Implementation Details

### Architectural Changes

1. **Single Source of Truth**: Supabase is now the only data source for the application.

2. **Toggle between Local and Remote**: The application can toggle between local and remote Supabase databases using environment variables:
   - `PUBLIC_SUPABASE_URL`: URL for the remote Supabase instance
   - `PUBLIC_SUPABASE_ANON_KEY`: Public anon key for the remote instance
   - `PUBLIC_USE_LOCAL_DATABASE`: Boolean flag to toggle between local and remote

3. **Data Access Pattern**:
   - Components now import the Supabase client directly from `src/lib/supabase`
   - Queries are made directly to the database using Supabase's query builder
   - Data is converted from database records to application entities using conversion functions

### Example Usage in Components

```typescript
// In Astro component frontmatter
---
import { supabase } from '../lib/supabase';
import { dbCompanyToCompany } from '../interfaces/entities/Company';

// Fetch data directly from Supabase
const { data: companiesData, error } = await supabase
  .from('companies')
  .select('*')
  .order('name');

// Handle errors
if (error) {
  console.error('Error fetching companies:', error);
}

// Convert database records to application entities
const companies = companiesData ? companiesData.map(dbCompanyToCompany) : [];
---

<!-- Use the data in your template -->
<div>
  {companies.map(company => (
    <CompanyCard company={company} />
  ))}
</div>
```

## Transition Status

This transition simplifies the data layer of the application by removing the abstraction and allowing components to access Supabase directly. We've made significant progress, but there are still components and utility functions that need to be updated.

The application is currently in a mixed state where some components use the new pattern while others still use the old utilities. The priority is to complete this transition and remove the old code paths. 